<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zooco</title>
    <link rel="stylesheet" href="styles.css">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0"/>
</head>
<body>
    <!-- Google tag (gtag.js) -->
<!-- <script async src="https://www.googletagmanager.com/gtag/js?id=G-141MXQ8JMT"></script> -->
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-141MXQ8JMT');
</script>
    <div class="chat-container">
        <img src="./logo.jpg">
        <div class="messages" id="messages"></div>
        <div class="message-input">
            <input type="text" id="messageBox" placeholder="Escribe tu mensaje aqui...">
            <button id="send" title="Send Message!">Enviar</button>
        </div>
    </div>
    <!-- Agrega un modal o una sección para el nombre del usuario -->
    <div id="nameModal" class="modal">
      <div class="modal-content">
          <input type="text" id="userName" placeholder="Escribe tu nombre aqui...">
          <button id="nameSubmit" title="Submit Name">Aceptar</button>
      </div>
    </div>
</body>
</html>

<script>
  (function() {
    const sendBtn = document.querySelector('#send');
    const messages = document.querySelector('#messages');
    const messageBox = document.querySelector('#messageBox');

    const nameModal = document.querySelector('#nameModal'); // Modal para el nombre del usuario
    const nameSubmit = document.querySelector('#nameSubmit'); // Botón para enviar el nombre
    const userNameInput = document.querySelector('#userName'); // Input del nombre del usuario

    let ws;
    let userName = 'Anonymous'; // Nombre por defecto

    function showMessage(message, mineText) {
      const messageParts = message.split('|'); // Separar el mensaje en partes
      
      // Crear un contenedor para el mensaje completo
      const messageContainer = document.createElement('div');
      messageContainer.classList.add('message');

      if(mineText){
        messageContainer.classList.add('right');
      }
      
      // Crear y añadir el elemento p para el nombre
      const nameElement = document.createElement('p');
      nameElement.classList.add('message-name');
      nameElement.textContent = messageParts[0]; // Parte 0 del mensaje (nombre)
      messageContainer.appendChild(nameElement);
      
      // Crear y añadir el elemento p para el mensaje
      const textElement = document.createElement('p');
      textElement.classList.add('message-text');
      textElement.textContent = messageParts[1]; // Parte 1 del mensaje (texto del mensaje)
      messageContainer.appendChild(textElement);

      messages.appendChild(messageContainer);

      // Desplazar el contenedor de mensajes al último mensaje
      messages.scrollTop = messages.scrollHeight;
      messageBox.value = '';
    }

    function init() {
      if (ws) {
        ws.onerror = ws.onopen = ws.onclose = null;
        ws.close();
      }

      ws = new WebSocket('wss://zoocochat.com/wss');
      //ws = new WebSocket('ws://localhost:8100');
      ws.onopen = () => {
        console.log('Connection opened!');
      }
      ws.onmessage = ({ data }) => showMessage(data, false);
      ws.onclose = function() {
        ws = null;
      }
    }

    const forbiddenWords = ['puta', 'pene', 'coño', 'chocho', 'xoxo', 'polla', 'mierda', 'marica', 'maricon', 'gilipollas', 'imbecil', 'subnormal', 'cancer', 'zorra', 'guarra', 'guarro', 'cerda', 'cerdo'];

    function filterMessage(message) {
        let filteredMessage = message;
        forbiddenWords.forEach(word => {
            const regex = new RegExp(word, 'gi'); // 'g' para global, 'i' para ignorar mayúsculas/minúsculas
            filteredMessage = filteredMessage.replace(regex, '****'); // Reemplaza por asteriscos o lo que prefieras
        });
        return filteredMessage;
    }

    sendBtn.onclick = function() {
      if (!ws) {
        showMessage("Algo está fallando, recarga la página web :(");
        return ;
      }

      const originalMessage = messageBox.value;
      const filteredMessage = filterMessage(originalMessage);

      if(filteredMessage != "" && filteredMessage != " "){
        ws.send(userName + "|" + filteredMessage);
        showMessage(userName + "|" + filteredMessage, true);
      }
    }

    nameSubmit.onclick = function() {
        userName = userNameInput.value || 'Anonimo'; // Asegúrate de tener un nombre válido
        nameModal.style.display = 'none'; // Oculta el modal después de obtener el nombre
        //init(); // Inicia la conexión WebSocket
    }

    // Mostrar el modal al cargar la página para que el usuario ingrese su nombre
    document.addEventListener('DOMContentLoaded', function() {
        nameModal.style.display = 'block';
    });
    init();
  })();
</script>
